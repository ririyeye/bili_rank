# B站视频实时在线人数排行榜 - Rust 版本

这是一个 Rust 实现的 B 站排行榜爬虫，可以获取 B 站热门视频的实时在线观看人数。

## 功能特性

- 🚀 **快速首轮查询**: 启动时使用高并发（默认 20 并发）快速获取数据
- ⏱️ **定时轮询**: 后续按指定间隔（默认 300 秒）定时更新数据
- 🌐 **内置 HTTP 服务器**: 提供 Web 界面和 JSON API
- 📊 **进度跟踪**: 实时显示抓取进度
- 🔧 **灵活配置**: 支持多种命令行参数
- 📚 **历史合并**: 保留多个周期的排行榜数据，合并去重后抓取
- 🏆 **智能排序**: 按在线人数排序，只输出 Top N 视频

## 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│  Step 1: 获取当前排行榜                                      │
│  调用 B站排行榜 API 获取本轮排行榜视频列表                    │
│  URL: /x/web-interface/ranking/v2?rid=0&type=all            │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 2: 加入历史队列并合并去重                              │
│  - 将新排行榜加入历史队列                                    │
│  - 保留最近 N 个周期（默认 5 个）                            │
│  - 合并所有周期的视频，按 bvid 去重                          │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 3: 并发获取在线人数                                    │
│  对合并后的所有视频并发请求在线人数                           │
│  URL: /x/player/online/total?bvid={}&cid={}                 │
│                                                             │
│  🚀 首轮并发数: rapid_concurrency (默认 20)                  │
│  🐢 后续并发数: normal_concurrency (默认 5)                  │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 4: 排序并取前 N 个                                     │
│  - 按 online_total 降序排序                                  │
│  - 取前 top_n 个视频（默认 100）                             │
│  - 生成 JSON 输出供 HTTP 接口使用                            │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 5: 等待下一轮                                          │
│  默认间隔: 300 秒（5 分钟）                                   │
│  循环回到 Step 1                                             │
└─────────────────────────────────────────────────────────────┘
```

## 编译

```bash
cd bili_rank_rust
cargo build --release
```

编译后的可执行文件位于 `target/release/bili_rank.exe`（Windows）或 `target/release/bili_rank`（Linux/macOS）。

## 使用方法

### 基本用法

```bash
# 使用默认配置启动（端口 8000，间隔 300 秒）
./bili_rank

# 指定端口
./bili_rank --port 8080

# 指定查询间隔（秒）
./bili_rank --interval 600
```

### 命令行参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--host` | `0.0.0.0` | 监听地址 |
| `--port` | `8000` | 监听端口 |
| `--interval` | `300` | 查询间隔（秒） |
| `--output-file` | `false` | 是否输出 data.json 文件 |
| `--output-path` | `data.json` | 输出文件路径 |
| `--rapid-concurrency` | `20` | 第一轮并发数 |
| `--normal-concurrency` | `5` | 后续轮次并发数 |
| `--log-error-json` | `false` | 是否记录错误响应的 JSON |
| `--history-cycles` | `5` | 保留的历史周期数（用于合并去重） |
| `--top-n` | `100` | 最终输出的视频数量（按在线人数排序） |

### 示例

```bash
# 完整配置示例
./bili_rank \
    --host 0.0.0.0 \
    --port 8000 \
    --interval 300 \
    --rapid-concurrency 30 \
    --normal-concurrency 10

# 输出 JSON 文件
./bili_rank --output-file --output-path ./data.json

# 自定义历史周期和输出数量
./bili_rank --history-cycles 3 --top-n 50
```

## API 接口

启动后可访问以下接口：

| 接口 | 说明 |
|------|------|
| `GET /` | Web 界面 |
| `GET /index.html` | Web 界面 |
| `GET /data.json` | 排行榜 JSON 数据 |
| `GET /progress` | 抓取进度 |
| `GET /progress.json` | 抓取进度（同上） |
| `GET /status` | 抓取状态（同上） |

### 数据格式

`/data.json` 返回格式：

```json
{
  "BV1xxxxxxxxxx": {
    "title": "视频标题",
    "owner": "UP主名称",
    "mid": "UP主ID",
    "pic": "封面图片URL",
    "online_count": "1.5万+",
    "count_num": 15000
  }
}
```

`/progress` 返回格式：

```json
{
  "fetching": true,
  "completed": 50,
  "total": 100,
  "percent": 50.0,
  "last_data_time": "Thu, 27 Nov 2025 14:30:00 GMT",
  "progress_time": "Thu, 27 Nov 2025 14:30:05 GMT"
}
```

## 与 C++ 版本的对比

| 特性 | C++ 版本 | Rust 版本 |
|------|----------|-----------|
| 默认端口 | 8000 | 8000 |
| 默认间隔 | 300s | 300s |
| 首轮并发 | 20 | 20 |
| 输出文件 | 默认输出 | 默认不输出 |
| TLS 支持 | OpenSSL | rustls |

## 依赖

- `tokio` - 异步运行时
- `reqwest` - HTTP 客户端
- `axum` - Web 框架
- `serde` / `serde_json` - JSON 序列化
- `clap` - 命令行解析
- `tracing` - 日志

## 许可证

MIT License
